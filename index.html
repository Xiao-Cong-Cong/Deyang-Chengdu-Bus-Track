<html>
    <head>
        <meta charset="UTF-8">
        <title>DeYang-Chengdu Metro bus track</title>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
		<script src="https://webapi.amap.com/maps?v=1.4.15&key=74ad0628ee4b58175f67dc5068bb8b5a"></script>
		<link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    </head>
    <body>


<style>
    html, body{
		margin: 0;
        height: 100%;
        width: 100%;
    }
	
	#container {
		position: absolute;
		height: 100%;
		width: 750px;
	}

	#control {
		margin-left: 760px;
	}
</style>
<div id="app">
	<div id="container"></div>
	<div id="control">
		<v-app>
			<v-slider
				v-model="slider"
				:max="maxSlider"
				:min="minSlider"
				hide-details
			></v-slider>
		</v-app>
	</div>
</div>
<script>
	var app = new Vue({
		el: '#app',
		vuetify: new Vuetify(),
		data() {
			return {
				date: '',
				time: 0,
				bus: [],
				log: [],
				map: null,
				points: [],
				bounds: [],
				rectangles: [],
				busMarkers: [],
				pointMarkers: [],
				startTime: -1,
				endTime: -1,
				slider: 0,
				maxSlider: 0,
				minSlider: 0
			}
		},
		watch: {
			date() { this.loadData(this.calc); },
			time() { this.slider = Math.floor(this.time / 600); },
			slider() {
				if(this.slider !== Math.floor(this.time / 600)) {
					this.time = this.slider * 600;
					this.initDisplay();
				}
			}
		},
		mounted() {
			this.date = '2020-09-01';
			this.points = [
				{x: 104.3905, y: 31.1690},	// 0 充电
				{x: 104.3935, y: 31.1720},
				{x: 104.3896, y: 31.1265},	// 1 文庙出发
				{x: 104.3912, y: 31.1272},
				{x: 104.1935, y: 30.8166},	// 2 到达新都
				{x: 104.1970, y: 30.8174},
				{x: 104.1950, y: 30.8163},	// 3 新都出发
				{x: 104.1962, y: 30.8168},
				{x: 104.3930, y: 31.1260},	// 4 到达文庙
				{x: 104.3945, y: 31.1269},
				{x: 104.3755, y: 31.1305},	// 5 文庙等待
				{x: 104.3820, y: 31.1350},
				{x: 104.1940, y: 30.8180},	// 6 新都等待
				{x: 104.1980, y: 30.8240},
			];

			this.map = new AMap.Map("container", {
				resizeEnable: true,
				center: [104.30, 30.9666],
				zoom: 11
			});
			this.initBounds();
			this.initRectangles();
			this.initPointMarkers();

			this.loadData(this.calc);
			window.onhashchange = this.onHashChange;
		},
		methods: {
			initBounds() {
				for(var i = 1; i < this.points.length; i+=2) {
					this.bounds.push(new AMap.Bounds(
						new AMap.LngLat(this.points[i-1].x, this.points[i-1].y),
						new AMap.LngLat(this.points[ i ].x, this.points[ i ].y)
					));
				}
			},
			initRectangles() {
				for(var i = 0; i < this.bounds.length; i++) {
					this.rectangles.push(new AMap.Rectangle({
						bounds: this.bounds[i],
						strokeOpacity: 0.6,
						strokeColor: 'red',
						strokeWeight: 2,
						fillOpacity: 0,
						map: this.map
					}));
				}
			},
			initPointMarkers() {
				for(var i = 0; i < this.points.length; i++) {
					this.pointMarkers.push(new AMap.Marker({
						map: this.map,
						position: new AMap.LngLat(this.points[i].x, this.points[i].y),
						icon: new AMap.Icon({
							size: new AMap.Size(16, 16),
							image: "http://bus.scyhrt.com/images/point.png",
							imageSize: new AMap.Size(16, 16)
						}),
						offset: new AMap.Pixel(-8, -8),
						draggable: true
					}));
					this.pointMarkers[i].on('dragging', this.onDragPoint);
				}
			},
			onDragPoint(e) {
				for(var i = 0; i < this.pointMarkers.length; i++)
					if(e.target._amap_id === this.pointMarkers[i]._amap_id) break;
				if(i === this.pointMarkers.length) {
					console.log("Can not find the pointMaker");
				} else {
					var p = this.pointMarkers[i].getPosition();
					this.points[i] = {x: p.getLng(), y: p.getLat()};
					var j = i % 2 ? i-1 : i;
					this.bounds[j/2] = new AMap.Bounds(
						new AMap.LngLat(this.points[ j ].x, this.points[ j ].y),
						new AMap.LngLat(this.points[j+1].x, this.points[j+1].y)
					);
					this.rectangles[j/2].setBounds(this.bounds[j/2]);
				}
			},
			onHashChange() {
				var hash = location.hash.slice(1);
				if(/(20\d{2})-((0|1)\d)-((0|1|2|3)\d)/.test(hash))
					this.date = hash;
			},
			loadData(cb) {
				var request = new XMLHttpRequest();
				request.open("get", './data/' + this.date + '.json');
				request.send(null);
				request.onload = () => { this.bus = JSON.parse(request.responseText); cb(); }
			},
			calc() {
				var chepaihao = ["川F00055D", "川F00019D", "川F00186D", "川F00881D", "川F00031D", "川F00065D", "川F00016D", "川F00058D", "川F00056D", "川F00076D"];
				this.startTime = -1;
				this.endTime = -1;
				var area = [];
				for(var i = 0; i < this.bus.length; i++) {
					area.push(-1);
					this.bus[i].p = 0;
					this.bus[i].cphid = chepaihao.indexOf(this.bus[i].cph) + 1;
				}
				for(var t = 0; t < 25 * 3600; t++) {
					for(var i = 0; i < this.bus.length; i++) {
						var car = this.bus[i];
						var d = car.data;
						while(car.p < d.length && t > d[car.p].t) car.p++;
						if(car.p < d.length && t === d[car.p].t) {
							var po = new AMap.LngLat(d[car.p].x, d[car.p].y);
							if(area[i] >= 0 && !this.bounds[area[i]].contains(po)) {
								this.log.push({
									t: t,
									i: car.cphid,
									a: area[i],
									s: 0
								});
								// First time leave charging area.
								if(area[i] === 0 && this.startTime < 0) this.startTime = t;
								area[i] = -1;
							}
							for(var j = 0; j < this.bounds.length; j++)
								if(this.bounds[j].contains(po) && area[i] !== j) {
									this.log.push({
										t: t,
										i: car.cphid,
										a: j,
										s: 1
									});
									area[i] = j;
									// Last time enter charging area.
									if(j === 0 && t > this.endTime) this.endTime = t;
								}
						}
					}
				}

				this.startTime = Math.floor(this.startTime / 600) * 600;
				this.endTime = Math.ceil(this.endTime / 600) * 600;
				this.minSlider = this.startTime / 600;
				this.maxSlider = this.endTime / 600;
				this.time = this.startTime;
				this.initDisplay();
			},
			initDisplay() {
				for(var i = 0; i < this.busMarkers.length; i++)
					this.busMarkers[i].stopMove(), this.busMarkers[i].hide();
				this.busMarkers = [];

				for(var i = 0; i < this.bus.length; i++) {
					var car = this.bus[i];
					var d = car.data;
					car.p = 0;
					while(car.p < d.length - 1 && d[car.p + 1].t < this.time) car.p++;
					this.busMarkers.push(new AMap.Marker({
						map: this.map,
						position: new AMap.LngLat(d[car.p].x, d[car.p].y),
						icon: new AMap.Icon({
							size: new AMap.Size(30, 30),
							image: './img/' + car.cphid + '.png',
							imageSize: new AMap.Size(30, 30)
						}),
						offset: new AMap.Pixel(-15,-15)
					}));
					// drive to
				}
			}
		}
	});
</script>



    </body>
</html>